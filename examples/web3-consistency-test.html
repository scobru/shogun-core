<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web3 Consistency Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .warning { color: #ffc107; font-weight: bold; }
        .info { color: #17a2b8; }
        h1 { color: #333; }
        h2 { color: #666; border-bottom: 2px solid #007bff; padding-bottom: 5px; }
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .approach {
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
        }
        .approach.normal { border-color: #28a745; }
        .approach.oneshot { border-color: #007bff; }
        .result-item {
            margin: 5px 0;
            padding: 5px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .match { background: #d4edda !important; }
        .mismatch { background: #f8d7da !important; }
        .metamask-required {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            color: #856404;
        }
    </style>
</head>
<body>
    <h1>ü¶ä Web3/MetaMask Consistency Test</h1>
    <p>This test verifies that the oneshot signing approach creates the <strong>same Gun user</strong> as the normal Web3/MetaMask approach.</p>

    <!-- MetaMask Check -->
    <div class="container">
        <h2>MetaMask Status</h2>
        <div id="metamask-status" class="metamask-required">
            <strong>‚ö†Ô∏è Checking MetaMask availability...</strong>
        </div>
    </div>

    <!-- Test Setup -->
    <div class="container">
        <h2>Test Setup</h2>
        <input type="text" id="test-address" placeholder="Enter Ethereum address (0x...)" style="padding: 8px; margin-right: 10px; width: 400px;">
        <button onclick="connectMetaMask()">ü¶ä Connect MetaMask</button>
        <button onclick="runConsistencyTest()" id="test-btn" disabled>üß™ Run Consistency Test</button>
        <button onclick="clearResults()">üóëÔ∏è Clear Results</button>
    </div>

    <!-- Test Results -->
    <div class="container">
        <h2>Test Results</h2>
        <div id="test-status" class="output"></div>
        
        <div class="comparison">
            <!-- Normal Approach -->
            <div class="approach normal">
                <h3>üîê Normal Web3 Approach</h3>
                <div id="normal-results">
                    <div class="result-item">Status: <span id="normal-status">Not started</span></div>
                    <div class="result-item">Address: <span id="normal-address">-</span></div>
                    <div class="result-item">Username: <span id="normal-username">-</span></div>
                    <div class="result-item">Password: <span id="normal-password">-</span></div>
                    <div class="result-item">Gun User Pub: <span id="normal-user-pub">-</span></div>
                    <div class="result-item">Derived Pub: <span id="normal-derived-pub">-</span></div>
                </div>
            </div>

            <!-- Oneshot Approach -->
            <div class="approach oneshot">
                <h3>‚ö° Oneshot Signing Approach</h3>
                <div id="oneshot-results">
                    <div class="result-item">Status: <span id="oneshot-status">Not started</span></div>
                    <div class="result-item">Address: <span id="oneshot-address">-</span></div>
                    <div class="result-item">Username: <span id="oneshot-username">-</span></div>
                    <div class="result-item">Password: <span id="oneshot-password">-</span></div>
                    <div class="result-item">Gun User Pub: <span id="oneshot-user-pub">-</span></div>
                    <div class="result-item">Derived Pub: <span id="oneshot-derived-pub">-</span></div>
                </div>
            </div>
        </div>

        <!-- Consistency Check -->
        <div class="container" style="margin-top: 20px;">
            <h3>‚úÖ Consistency Check</h3>
            <div id="consistency-results">
                <div class="result-item">Addresses Match: <span id="check-address">-</span></div>
                <div class="result-item">Usernames Match: <span id="check-username">-</span></div>
                <div class="result-item">Passwords Match: <span id="check-password">-</span></div>
                <div class="result-item">Gun User Pubs Match: <span id="check-user-pub">-</span></div>
                <div class="result-item">Derived Pubs Match: <span id="check-derived-pub">-</span></div>
                <div class="result-item"><strong>Overall Consistency: <span id="check-overall">-</span></strong></div>
            </div>
        </div>
    </div>

    <!-- Detailed Logs -->
    <div class="container">
        <h2>üìã Detailed Logs</h2>
        <div id="detailed-logs" class="output"></div>
    </div>

    <!-- Include required libraries -->
    <script src="/gun/gun.js"></script>
    <script src="/gun/sea.js"></script>
    
    <script>
        // Initialize Gun
        const gun = new Gun();
        
        // Test state
        let normalResult = null;
        let oneshotResult = null;
        let connectedAddress = null;

        // Mock implementations for testing (since we can't import the actual modules in browser)
        class MockWeb3Normal {
            async generateCredentials(address) {
                // Simulate normal Web3 credential generation
                // This would normally request a MetaMask signature
                const mockSignature = `0x${Array(130).fill(0).map(() => Math.floor(Math.random() * 16).toString(16)).join('')}`;
                const username = address.toLowerCase();
                const password = this.hashPassword(`${mockSignature}:${address.toLowerCase()}`);
                
                return { username, password, signature: mockSignature, message: "I Love Shogun!" };
            }

            async signUp(address) {
                const credentials = await this.generateCredentials(address);
                
                return new Promise((resolve) => {
                    gun.user().create(credentials.username, credentials.password, (ack) => {
                        if (ack.err) {
                            gun.user().auth(credentials.username, credentials.password, (authAck) => {
                                resolve({
                                    success: !authAck.err,
                                    userPub: authAck.pub,
                                    credentials,
                                    error: authAck.err
                                });
                            });
                        } else {
                            gun.user().auth(credentials.username, credentials.password, (authAck) => {
                                resolve({
                                    success: !authAck.err,
                                    userPub: authAck.pub,
                                    credentials,
                                    error: authAck.err
                                });
                            });
                        }
                    });
                });
            }

            hashPassword(input) {
                // Mock ethers.keccak256(ethers.toUtf8Bytes(input))
                let hash = 0;
                for (let i = 0; i < input.length; i++) {
                    const char = input.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // Convert to 32bit integer
                }
                return Math.abs(hash).toString(16).padStart(64, '0');
            }

            async getDerivedKeys(password) {
                // Mock derive function
                const hash = this.hashPassword(password + 'derived');
                const pub = hash.substring(0, 32);
                return { pub };
            }
        }

        class MockWeb3Oneshot {
            async setupConsistentOneshotSigning(address) {
                // Simulate oneshot signing setup with SAME password generation
                const mockSignature = `0x${Array(130).fill(0).map(() => Math.floor(Math.random() * 16).toString(16)).join('')}`;
                const username = address.toLowerCase();
                const password = this.hashPassword(`${mockSignature}:${address.toLowerCase()}`);
                
                const credential = {
                    address,
                    username,
                    password,
                    signature: mockSignature,
                    message: "I Love Shogun!"
                };

                const gunUser = await new Promise((resolve) => {
                    gun.user().create(username + '-oneshot', password, (ack) => {
                        if (ack.err) {
                            gun.user().auth(username + '-oneshot', password, (authAck) => {
                                resolve({
                                    success: !authAck.err,
                                    userPub: authAck.pub,
                                    error: authAck.err
                                });
                            });
                        } else {
                            gun.user().auth(username + '-oneshot', password, (authAck) => {
                                resolve({
                                    success: !authAck.err,
                                    userPub: authAck.pub,
                                    error: authAck.err
                                });
                            });
                        }
                    });
                });

                return { credential, gunUser };
            }

            hashPassword(input) {
                // Same hashing as normal approach
                let hash = 0;
                for (let i = 0; i < input.length; i++) {
                    const char = input.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // Convert to 32bit integer
                }
                return Math.abs(hash).toString(16).padStart(64, '0');
            }

            async getDerivedKeys(password) {
                // Same derive function as normal approach
                const hash = this.hashPassword(password + 'derived');
                const pub = hash.substring(0, 32);
                return { pub };
            }
        }

        const normalWeb3 = new MockWeb3Normal();
        const oneshotWeb3 = new MockWeb3Oneshot();

        // Check MetaMask availability
        function checkMetaMask() {
            const statusDiv = document.getElementById('metamask-status');
            const testBtn = document.getElementById('test-btn');
            
            if (typeof window.ethereum !== 'undefined' && window.ethereum.isMetaMask) {
                statusDiv.innerHTML = '<strong>‚úÖ MetaMask is available!</strong> You can run the consistency test.';
                statusDiv.className = 'success';
                testBtn.disabled = false;
                log('‚úÖ MetaMask detected', 'success');
            } else {
                statusDiv.innerHTML = '<strong>‚ùå MetaMask not found.</strong> Please install MetaMask extension to run this test.';
                statusDiv.className = 'error';
                testBtn.disabled = true;
                log('‚ùå MetaMask not detected', 'error');
            }
        }

        // Connect to MetaMask
        async function connectMetaMask() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    throw new Error('MetaMask not found');
                }

                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });

                if (accounts.length > 0) {
                    connectedAddress = accounts[0];
                    document.getElementById('test-address').value = connectedAddress;
                    log(`‚úÖ Connected to MetaMask: ${connectedAddress}`, 'success');
                    document.getElementById('test-btn').disabled = false;
                } else {
                    throw new Error('No accounts found');
                }
            } catch (error) {
                log(`‚ùå Failed to connect to MetaMask: ${error.message}`, 'error');
            }
        }

        // Utility functions
        function log(message, type = 'info') {
            const logDiv = document.getElementById('detailed-logs');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('test-status');
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            statusDiv.innerHTML = `<div class="${className}">${message}</div>`;
        }

        function clearResults() {
            document.getElementById('detailed-logs').innerHTML = '';
            document.getElementById('test-status').innerHTML = '';
            
            // Reset normal results
            document.getElementById('normal-status').textContent = 'Not started';
            document.getElementById('normal-address').textContent = '-';
            document.getElementById('normal-username').textContent = '-';
            document.getElementById('normal-password').textContent = '-';
            document.getElementById('normal-user-pub').textContent = '-';
            document.getElementById('normal-derived-pub').textContent = '-';
            
            // Reset oneshot results
            document.getElementById('oneshot-status').textContent = 'Not started';
            document.getElementById('oneshot-address').textContent = '-';
            document.getElementById('oneshot-username').textContent = '-';
            document.getElementById('oneshot-password').textContent = '-';
            document.getElementById('oneshot-user-pub').textContent = '-';
            document.getElementById('oneshot-derived-pub').textContent = '-';
            
            // Reset consistency check
            document.getElementById('check-address').textContent = '-';
            document.getElementById('check-username').textContent = '-';
            document.getElementById('check-password').textContent = '-';
            document.getElementById('check-user-pub').textContent = '-';
            document.getElementById('check-derived-pub').textContent = '-';
            document.getElementById('check-overall').textContent = '-';
            
            normalResult = null;
            oneshotResult = null;
        }

        async function runConsistencyTest() {
            const address = document.getElementById('test-address').value;
            if (!address) {
                updateStatus('Please enter an Ethereum address or connect MetaMask', 'error');
                return;
            }

            if (!address.match(/^0x[a-fA-F0-9]{40}$/)) {
                updateStatus('Please enter a valid Ethereum address (0x...)', 'error');
                return;
            }

            clearResults();
            updateStatus('Running Web3 consistency test...', 'info');
            log('Starting Web3 consistency test', 'info');

            try {
                // Test 1: Normal Web3 Approach
                log('Testing normal Web3 approach...', 'info');
                document.getElementById('normal-status').textContent = 'Running...';
                
                normalResult = await normalWeb3.signUp(address);
                
                if (normalResult.success) {
                    document.getElementById('normal-status').textContent = '‚úÖ Success';
                    document.getElementById('normal-address').textContent = address.substring(0, 10) + '...';
                    document.getElementById('normal-username').textContent = normalResult.credentials.username.substring(0, 15) + '...';
                    document.getElementById('normal-password').textContent = normalResult.credentials.password.substring(0, 15) + '...';
                    document.getElementById('normal-user-pub').textContent = normalResult.userPub ? normalResult.userPub.substring(0, 15) + '...' : 'None';
                    
                    // Get derived keys
                    const normalDerived = await normalWeb3.getDerivedKeys(normalResult.credentials.password);
                    document.getElementById('normal-derived-pub').textContent = normalDerived.pub.substring(0, 15) + '...';
                    normalResult.derivedPub = normalDerived.pub;
                    
                    log(`Normal approach: Created user with pub ${normalResult.userPub}`, 'success');
                } else {
                    document.getElementById('normal-status').textContent = '‚ùå Failed';
                    log(`Normal approach failed: ${normalResult.error}`, 'error');
                }

                // Test 2: Oneshot Signing Approach
                log('Testing oneshot signing approach...', 'info');
                document.getElementById('oneshot-status').textContent = 'Running...';
                
                oneshotResult = await oneshotWeb3.setupConsistentOneshotSigning(address);
                
                if (oneshotResult.gunUser.success) {
                    document.getElementById('oneshot-status').textContent = '‚úÖ Success';
                    document.getElementById('oneshot-address').textContent = address.substring(0, 10) + '...';
                    document.getElementById('oneshot-username').textContent = oneshotResult.credential.username.substring(0, 15) + '...';
                    document.getElementById('oneshot-password').textContent = oneshotResult.credential.password.substring(0, 15) + '...';
                    document.getElementById('oneshot-user-pub').textContent = oneshotResult.gunUser.userPub ? oneshotResult.gunUser.userPub.substring(0, 15) + '...' : 'None';
                    
                    // Get derived keys
                    const oneshotDerived = await oneshotWeb3.getDerivedKeys(oneshotResult.credential.password);
                    document.getElementById('oneshot-derived-pub').textContent = oneshotDerived.pub.substring(0, 15) + '...';
                    oneshotResult.derivedPub = oneshotDerived.pub;
                    
                    log(`Oneshot approach: Created user with pub ${oneshotResult.gunUser.userPub}`, 'success');
                } else {
                    document.getElementById('oneshot-status').textContent = '‚ùå Failed';
                    log(`Oneshot approach failed: ${oneshotResult.gunUser.error}`, 'error');
                }

                // Test 3: Consistency Check
                log('Checking consistency...', 'info');
                
                if (normalResult.success && oneshotResult.gunUser.success) {
                    // Check addresses (should match)
                    const addressesMatch = address.toLowerCase() === oneshotResult.credential.address.toLowerCase();
                    document.getElementById('check-address').textContent = addressesMatch ? '‚úÖ Match' : '‚ùå Mismatch';
                    document.getElementById('check-address').className = addressesMatch ? 'match' : 'mismatch';
                    
                    // Check usernames (should match since both use address.toLowerCase())
                    const usernamesMatch = normalResult.credentials.username === oneshotResult.credential.username;
                    document.getElementById('check-username').textContent = usernamesMatch ? '‚úÖ Match' : '‚ùå Mismatch';
                    document.getElementById('check-username').className = usernamesMatch ? 'match' : 'mismatch';
                    
                    // Check passwords (should match if same signature logic)
                    const passwordsMatch = normalResult.credentials.password === oneshotResult.credential.password;
                    document.getElementById('check-password').textContent = passwordsMatch ? '‚úÖ Match' : '‚ùå Mismatch';
                    document.getElementById('check-password').className = passwordsMatch ? 'match' : 'mismatch';
                    
                    // Check Gun user pubs (should be different since different usernames in test)
                    const userPubsMatch = normalResult.userPub === oneshotResult.gunUser.userPub;
                    document.getElementById('check-user-pub').textContent = userPubsMatch ? '‚ùå Same (unexpected)' : '‚úÖ Different (expected)';
                    document.getElementById('check-user-pub').className = userPubsMatch ? 'mismatch' : 'match';
                    
                    // Check derived pubs (should match if same password)
                    const derivedPubsMatch = normalResult.derivedPub === oneshotResult.derivedPub;
                    document.getElementById('check-derived-pub').textContent = derivedPubsMatch ? '‚úÖ Match' : '‚ùå Mismatch';
                    document.getElementById('check-derived-pub').className = derivedPubsMatch ? 'match' : 'mismatch';
                    
                    // Overall consistency (key fields should match)
                    const consistent = addressesMatch && usernamesMatch && passwordsMatch && derivedPubsMatch;
                    document.getElementById('check-overall').textContent = consistent ? '‚úÖ CONSISTENT' : '‚ùå INCONSISTENT';
                    document.getElementById('check-overall').className = consistent ? 'success' : 'error';
                    
                    if (consistent) {
                        updateStatus('‚úÖ Consistency test PASSED! Both approaches generate the same credentials.', 'success');
                        log('Consistency test PASSED: Both approaches are consistent', 'success');
                    } else {
                        updateStatus('‚ùå Consistency test FAILED! There are inconsistencies between approaches.', 'error');
                        log('Consistency test FAILED: Inconsistencies detected', 'error');
                    }
                } else {
                    updateStatus('‚ùå Cannot check consistency - one or both approaches failed', 'error');
                    log('Cannot perform consistency check due to failures', 'error');
                }

            } catch (error) {
                updateStatus(`‚ùå Test failed: ${error.message}`, 'error');
                log(`Test error: ${error.message}`, 'error');
            }
        }

        // Initialize
        checkMetaMask();
        log('Web3 Consistency Test loaded', 'success');

        // Listen for MetaMask events
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length > 0) {
                    connectedAddress = accounts[0];
                    document.getElementById('test-address').value = connectedAddress;
                    log(`Account changed: ${connectedAddress}`, 'info');
                } else {
                    connectedAddress = null;
                    document.getElementById('test-address').value = '';
                    log('MetaMask disconnected', 'warning');
                }
            });
        }
    </script>
</body>
</html> 