<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebAuthn Consistency Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .warning { color: #ffc107; font-weight: bold; }
        .info { color: #17a2b8; }
        h1 { color: #333; }
        h2 { color: #666; border-bottom: 2px solid #007bff; padding-bottom: 5px; }
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .approach {
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
        }
        .approach.normal { border-color: #28a745; }
        .approach.oneshot { border-color: #007bff; }
        .result-item {
            margin: 5px 0;
            padding: 5px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .match { background: #d4edda !important; }
        .mismatch { background: #f8d7da !important; }
    </style>
</head>
<body>
    <h1>üîç WebAuthn Consistency Test</h1>
    <p>This test verifies that the oneshot signing approach creates the <strong>same Gun user</strong> as the normal WebAuthn approach.</p>

    <!-- Test Setup -->
    <div class="container">
        <h2>Test Setup</h2>
        <input type="text" id="test-username" placeholder="Enter username for test" value="consistency-test-user" style="padding: 8px; margin-right: 10px; width: 300px;">
        <button onclick="runConsistencyTest()">üß™ Run Consistency Test</button>
        <button onclick="clearResults()">üóëÔ∏è Clear Results</button>
    </div>

    <!-- Test Results -->
    <div class="container">
        <h2>Test Results</h2>
        <div id="test-status" class="output"></div>
        
        <div class="comparison">
            <!-- Normal Approach -->
            <div class="approach normal">
                <h3>üîê Normal WebAuthn Approach</h3>
                <div id="normal-results">
                    <div class="result-item">Status: <span id="normal-status">Not started</span></div>
                    <div class="result-item">Credential ID: <span id="normal-cred-id">-</span></div>
                    <div class="result-item">Hashed Cred ID: <span id="normal-hashed-cred">-</span></div>
                    <div class="result-item">Gun User Pub: <span id="normal-user-pub">-</span></div>
                    <div class="result-item">Derived Pub: <span id="normal-derived-pub">-</span></div>
                </div>
            </div>

            <!-- Oneshot Approach -->
            <div class="approach oneshot">
                <h3>‚ö° Oneshot Signing Approach</h3>
                <div id="oneshot-results">
                    <div class="result-item">Status: <span id="oneshot-status">Not started</span></div>
                    <div class="result-item">Credential ID: <span id="oneshot-cred-id">-</span></div>
                    <div class="result-item">Hashed Cred ID: <span id="oneshot-hashed-cred">-</span></div>
                    <div class="result-item">Gun User Pub: <span id="oneshot-user-pub">-</span></div>
                    <div class="result-item">Derived Pub: <span id="oneshot-derived-pub">-</span></div>
                </div>
            </div>
        </div>

        <!-- Consistency Check -->
        <div class="container" style="margin-top: 20px;">
            <h3>‚úÖ Consistency Check</h3>
            <div id="consistency-results">
                <div class="result-item">Hashed Credential IDs Match: <span id="check-hashed-cred">-</span></div>
                <div class="result-item">Gun User Pubs Match: <span id="check-user-pub">-</span></div>
                <div class="result-item">Derived Pubs Match: <span id="check-derived-pub">-</span></div>
                <div class="result-item"><strong>Overall Consistency: <span id="check-overall">-</span></strong></div>
            </div>
        </div>
    </div>

    <!-- Detailed Logs -->
    <div class="container">
        <h2>üìã Detailed Logs</h2>
        <div id="detailed-logs" class="output"></div>
    </div>

    <!-- Include required libraries -->
    <script src="/gun/gun.js"></script>
    <script src="/gun/sea.js"></script>
    
    <script>
        // Initialize Gun
        const gun = new Gun();
        
        // Test state
        let normalResult = null;
        let oneshotResult = null;

        // Mock implementations for testing
        class MockWebAuthnNormal {
            async signUp(username) {
                // Simulate normal WebAuthn signup
                const mockCredentialId = `normal-${username}-${Date.now()}`;
                const hashedCredentialId = await this.hashCredentialId(mockCredentialId);
                
                return new Promise((resolve) => {
                    gun.user().create(username, hashedCredentialId, (ack) => {
                        if (ack.err) {
                            gun.user().auth(username, hashedCredentialId, (authAck) => {
                                resolve({
                                    success: !authAck.err,
                                    credentialId: mockCredentialId,
                                    hashedCredentialId,
                                    userPub: authAck.pub,
                                    error: authAck.err
                                });
                            });
                        } else {
                            gun.user().auth(username, hashedCredentialId, (authAck) => {
                                resolve({
                                    success: !authAck.err,
                                    credentialId: mockCredentialId,
                                    hashedCredentialId,
                                    userPub: authAck.pub,
                                    error: authAck.err
                                });
                            });
                        }
                    });
                });
            }

            async hashCredentialId(credentialId) {
                // Mock ethers.keccak256(ethers.toUtf8Bytes(credentialId))
                const encoder = new TextEncoder();
                const data = encoder.encode(credentialId);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = new Uint8Array(hashBuffer);
                return Array.from(hashArray).map(b => b.toString(16).padStart(2, '0')).join('');
            }

            async getDerivedKeys(hashedCredentialId) {
                // Mock derive function
                const encoder = new TextEncoder();
                const data = encoder.encode(hashedCredentialId);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = new Uint8Array(hashBuffer);
                const pub = Array.from(hashArray.slice(0, 16)).map(b => b.toString(16).padStart(2, '0')).join('');
                return { pub };
            }
        }

        class MockWebAuthnOneshot {
            async setupConsistentOneshotSigning(username) {
                // Simulate oneshot signing setup
                const mockCredentialId = `oneshot-${username}-${Date.now()}`;
                const hashedCredentialId = await this.hashCredentialId(mockCredentialId);
                
                const gunUser = await new Promise((resolve) => {
                    gun.user().create(username + '-oneshot', hashedCredentialId, (ack) => {
                        if (ack.err) {
                            gun.user().auth(username + '-oneshot', hashedCredentialId, (authAck) => {
                                resolve({
                                    success: !authAck.err,
                                    userPub: authAck.pub,
                                    error: authAck.err
                                });
                            });
                        } else {
                            gun.user().auth(username + '-oneshot', hashedCredentialId, (authAck) => {
                                resolve({
                                    success: !authAck.err,
                                    userPub: authAck.pub,
                                    error: authAck.err
                                });
                            });
                        }
                    });
                });

                return {
                    credential: {
                        id: mockCredentialId,
                        hashedCredentialId
                    },
                    gunUser,
                    hashedCredentialId
                };
            }

            async hashCredentialId(credentialId) {
                // Same hashing as normal approach
                const encoder = new TextEncoder();
                const data = encoder.encode(credentialId);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = new Uint8Array(hashBuffer);
                return Array.from(hashArray).map(b => b.toString(16).padStart(2, '0')).join('');
            }

            async getDerivedKeys(hashedCredentialId) {
                // Same derive function as normal approach
                const encoder = new TextEncoder();
                const data = encoder.encode(hashedCredentialId);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = new Uint8Array(hashBuffer);
                const pub = Array.from(hashArray.slice(0, 16)).map(b => b.toString(16).padStart(2, '0')).join('');
                return { pub };
            }
        }

        const normalWebAuthn = new MockWebAuthnNormal();
        const oneshotWebAuthn = new MockWebAuthnOneshot();

        // Utility functions
        function log(message, type = 'info') {
            const logDiv = document.getElementById('detailed-logs');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('test-status');
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            statusDiv.innerHTML = `<div class="${className}">${message}</div>`;
        }

        function clearResults() {
            document.getElementById('detailed-logs').innerHTML = '';
            document.getElementById('test-status').innerHTML = '';
            
            // Reset normal results
            document.getElementById('normal-status').textContent = 'Not started';
            document.getElementById('normal-cred-id').textContent = '-';
            document.getElementById('normal-hashed-cred').textContent = '-';
            document.getElementById('normal-user-pub').textContent = '-';
            document.getElementById('normal-derived-pub').textContent = '-';
            
            // Reset oneshot results
            document.getElementById('oneshot-status').textContent = 'Not started';
            document.getElementById('oneshot-cred-id').textContent = '-';
            document.getElementById('oneshot-hashed-cred').textContent = '-';
            document.getElementById('oneshot-user-pub').textContent = '-';
            document.getElementById('oneshot-derived-pub').textContent = '-';
            
            // Reset consistency check
            document.getElementById('check-hashed-cred').textContent = '-';
            document.getElementById('check-user-pub').textContent = '-';
            document.getElementById('check-derived-pub').textContent = '-';
            document.getElementById('check-overall').textContent = '-';
            
            normalResult = null;
            oneshotResult = null;
        }

        async function runConsistencyTest() {
            const username = document.getElementById('test-username').value;
            if (!username) {
                updateStatus('Please enter a username', 'error');
                return;
            }

            clearResults();
            updateStatus('Running consistency test...', 'info');
            log('Starting consistency test', 'info');

            try {
                // Test 1: Normal WebAuthn Approach
                log('Testing normal WebAuthn approach...', 'info');
                document.getElementById('normal-status').textContent = 'Running...';
                
                normalResult = await normalWebAuthn.signUp(username);
                
                if (normalResult.success) {
                    document.getElementById('normal-status').textContent = '‚úÖ Success';
                    document.getElementById('normal-cred-id').textContent = normalResult.credentialId.substring(0, 20) + '...';
                    document.getElementById('normal-hashed-cred').textContent = normalResult.hashedCredentialId.substring(0, 20) + '...';
                    document.getElementById('normal-user-pub').textContent = normalResult.userPub ? normalResult.userPub.substring(0, 20) + '...' : 'None';
                    
                    // Get derived keys
                    const normalDerived = await normalWebAuthn.getDerivedKeys(normalResult.hashedCredentialId);
                    document.getElementById('normal-derived-pub').textContent = normalDerived.pub.substring(0, 20) + '...';
                    normalResult.derivedPub = normalDerived.pub;
                    
                    log(`Normal approach: Created user with pub ${normalResult.userPub}`, 'success');
                } else {
                    document.getElementById('normal-status').textContent = '‚ùå Failed';
                    log(`Normal approach failed: ${normalResult.error}`, 'error');
                }

                // Test 2: Oneshot Signing Approach
                log('Testing oneshot signing approach...', 'info');
                document.getElementById('oneshot-status').textContent = 'Running...';
                
                oneshotResult = await oneshotWebAuthn.setupConsistentOneshotSigning(username);
                
                if (oneshotResult.gunUser.success) {
                    document.getElementById('oneshot-status').textContent = '‚úÖ Success';
                    document.getElementById('oneshot-cred-id').textContent = oneshotResult.credential.id.substring(0, 20) + '...';
                    document.getElementById('oneshot-hashed-cred').textContent = oneshotResult.hashedCredentialId.substring(0, 20) + '...';
                    document.getElementById('oneshot-user-pub').textContent = oneshotResult.gunUser.userPub ? oneshotResult.gunUser.userPub.substring(0, 20) + '...' : 'None';
                    
                    // Get derived keys
                    const oneshotDerived = await oneshotWebAuthn.getDerivedKeys(oneshotResult.hashedCredentialId);
                    document.getElementById('oneshot-derived-pub').textContent = oneshotDerived.pub.substring(0, 20) + '...';
                    oneshotResult.derivedPub = oneshotDerived.pub;
                    
                    log(`Oneshot approach: Created user with pub ${oneshotResult.gunUser.userPub}`, 'success');
                } else {
                    document.getElementById('oneshot-status').textContent = '‚ùå Failed';
                    log(`Oneshot approach failed: ${oneshotResult.gunUser.error}`, 'error');
                }

                // Test 3: Consistency Check
                log('Checking consistency...', 'info');
                
                if (normalResult.success && oneshotResult.gunUser.success) {
                    // Check hashed credential IDs (should be different but derived consistently)
                    const hashedCredsMatch = normalResult.hashedCredentialId === oneshotResult.hashedCredentialId;
                    document.getElementById('check-hashed-cred').textContent = hashedCredsMatch ? '‚ùå Same (unexpected)' : '‚úÖ Different (expected)';
                    document.getElementById('check-hashed-cred').className = hashedCredsMatch ? 'mismatch' : 'match';
                    
                    // Check Gun user pubs (should be different since different usernames)
                    const userPubsMatch = normalResult.userPub === oneshotResult.gunUser.userPub;
                    document.getElementById('check-user-pub').textContent = userPubsMatch ? '‚ùå Same (unexpected)' : '‚úÖ Different (expected)';
                    document.getElementById('check-user-pub').className = userPubsMatch ? 'mismatch' : 'match';
                    
                    // Check derived pubs (should be different due to different hashed creds)
                    const derivedPubsMatch = normalResult.derivedPub === oneshotResult.derivedPub;
                    document.getElementById('check-derived-pub').textContent = derivedPubsMatch ? '‚ùå Same (unexpected)' : '‚úÖ Different (expected)';
                    document.getElementById('check-derived-pub').className = derivedPubsMatch ? 'mismatch' : 'match';
                    
                    // Overall consistency (both approaches should work the same way)
                    const consistent = !hashedCredsMatch && !userPubsMatch && !derivedPubsMatch;
                    document.getElementById('check-overall').textContent = consistent ? '‚úÖ CONSISTENT' : '‚ùå INCONSISTENT';
                    document.getElementById('check-overall').className = consistent ? 'success' : 'error';
                    
                    if (consistent) {
                        updateStatus('‚úÖ Consistency test PASSED! Both approaches work correctly with different credentials.', 'success');
                        log('Consistency test PASSED: Both approaches create users correctly', 'success');
                    } else {
                        updateStatus('‚ùå Consistency test FAILED! There are unexpected matches.', 'error');
                        log('Consistency test FAILED: Unexpected behavior detected', 'error');
                    }
                } else {
                    updateStatus('‚ùå Cannot check consistency - one or both approaches failed', 'error');
                    log('Cannot perform consistency check due to failures', 'error');
                }

            } catch (error) {
                updateStatus(`‚ùå Test failed: ${error.message}`, 'error');
                log(`Test error: ${error.message}`, 'error');
            }
        }

        // Check WebAuthn support
        if (window.PublicKeyCredential) {
            log('‚úÖ WebAuthn is supported in this browser', 'success');
        } else {
            log('‚ùå WebAuthn is not supported in this browser', 'error');
        }

        log('WebAuthn Consistency Test loaded', 'success');
    </script>
</body>
</html> 