<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebAuthn Oneshot Signing Example</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
        h1 { color: #333; }
        h2 { color: #666; border-bottom: 2px solid #007bff; padding-bottom: 5px; }
        .credential-info {
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .step {
            margin: 15px 0;
            padding: 10px;
            border-left: 4px solid #007bff;
            background: #f8f9fa;
        }
    </style>
</head>
<body>
    <h1>üîê WebAuthn Oneshot Signing Example</h1>
    <p>This example demonstrates WebAuthn oneshot signing functionality similar to <code>webauthn.js</code> but integrated with your Shogun architecture and <code>derive.ts</code>.</p>

    <!-- Example 1: Basic Credential Creation -->
    <div class="container">
        <h2>1. Basic Credential Creation</h2>
        <div class="step">
            <p><strong>Step 1:</strong> Create a WebAuthn signing credential</p>
            <input type="text" id="username1" placeholder="Enter username" value="alice" style="padding: 8px; margin-right: 10px;">
            <button onclick="createSigningCredential()">Create Signing Credential</button>
        </div>
        <div id="credential-output" class="output"></div>
        <div id="credential-info" class="credential-info" style="display: none;">
            <strong>Credential Created:</strong>
            <div>ID: <span id="cred-id"></span></div>
            <div>Public Key: <span id="cred-pub"></span></div>
        </div>
    </div>

    <!-- Example 2: SEA.sign Compatible Authenticator -->
    <div class="container">
        <h2>2. SEA.sign Compatible Authenticator</h2>
        <div class="step">
            <p><strong>Step 2:</strong> Create authenticator function and sign data</p>
            <input type="text" id="data-to-sign" placeholder="Data to sign" value="Hello, World!" style="padding: 8px; margin-right: 10px;">
            <button onclick="signWithAuthenticator()" id="sign-btn" disabled>Sign with Authenticator</button>
        </div>
        <div id="sign-output" class="output"></div>
    </div>

    <!-- Example 3: Derived Keys Signing -->
    <div class="container">
        <h2>3. Derived Keys Signing</h2>
        <div class="step">
            <p><strong>Step 3:</strong> Use WebAuthn + derived keys for signing</p>
            <input type="text" id="derived-data" placeholder="Data to sign with derived keys" value="Derived key signature" style="padding: 8px; margin-right: 10px;">
            <button onclick="signWithDerivedKeys()" id="derived-btn" disabled>Sign with Derived Keys</button>
        </div>
        <div id="derived-output" class="output"></div>
    </div>

    <!-- Example 4: Gun Integration -->
    <div class="container">
        <h2>4. Gun Database Integration</h2>
        <div class="step">
            <p><strong>Step 4:</strong> Store signed data in Gun database</p>
            <input type="text" id="gun-data" placeholder="Data to store in Gun" value="Hello from Gun!" style="padding: 8px; margin-right: 10px;">
            <button onclick="storeInGun()" id="gun-btn" disabled>Store in Gun with Signature</button>
        </div>
        <div id="gun-output" class="output"></div>
    </div>

    <!-- Example 5: Multi-Device Demo -->
    <div class="container">
        <h2>5. Multi-Device Simulation</h2>
        <div class="step">
            <p><strong>Step 5:</strong> Create multiple credentials and compare signatures</p>
            <button onclick="multiDeviceDemo()">Create Multi-Device Demo</button>
        </div>
        <div id="multi-output" class="output"></div>
    </div>

    <!-- Status and Logs -->
    <div class="container">
        <h2>üìã Activity Log</h2>
        <button onclick="clearLog()">Clear Log</button>
        <button onclick="listCredentials()">List All Credentials</button>
        <div id="log" class="output"></div>
    </div>

    <!-- Include required libraries -->
    <script src="/gun/gun.js"></script>
    <script src="/gun/sea.js"></script>
    
    <script>
        // Initialize Gun
        const gun = new Gun();
        
        // Global variables
        let currentCredential = null;
        let currentAuthenticator = null;
        let webauthnSigner = null;

        // Mock WebAuthn Signer (simplified version for demo)
        class WebAuthnSignerDemo {
            constructor() {
                this.credentials = new Map();
            }

            async createSigningCredential(username) {
                try {
                    const credential = await navigator.credentials.create({
                        publicKey: {
                            challenge: crypto.getRandomValues(new Uint8Array(32)),
                            rp: { 
                                id: window.location.hostname === 'localhost' ? 'localhost' : window.location.hostname,
                                name: "Shogun Wallet Demo" 
                            },
                            user: {
                                id: new TextEncoder().encode(username),
                                name: username,
                                displayName: username
                            },
                            pubKeyCredParams: [
                                { type: "public-key", alg: -7 },   // ECDSA, P-256
                                { type: "public-key", alg: -25 },  // ECDH, P-256
                                { type: "public-key", alg: -257 }
                            ],
                            authenticatorSelection: {
                                userVerification: "preferred"
                            },
                            timeout: 60000,
                            attestation: "none"
                        }
                    });

                    if (!credential) {
                        throw new Error("Failed to create WebAuthn credential");
                    }

                    // Extract public key (simplified)
                    const response = credential.response;
                    const publicKey = response.getPublicKey();
                    const rawKey = new Uint8Array(publicKey);
                    
                    // Extract coordinates (positions may need adjustment)
                    const xCoord = rawKey.slice(27, 59);
                    const yCoord = rawKey.slice(59, 91);
                    
                    const x = this.base64urlEncode(xCoord);
                    const y = this.base64urlEncode(yCoord);
                    const pub = `${x}.${y}`;

                    const signingCredential = {
                        id: credential.id,
                        rawId: credential.rawId,
                        publicKey: { x, y },
                        pub,
                        username
                    };

                    this.credentials.set(credential.id, signingCredential);
                    return signingCredential;

                } catch (error) {
                    throw new Error(`Failed to create signing credential: ${error.message}`);
                }
            }

            createAuthenticator(credentialId) {
                const credential = this.credentials.get(credentialId);
                if (!credential) {
                    throw new Error(`Credential ${credentialId} not found`);
                }

                return async (data) => {
                    try {
                        const challenge = new TextEncoder().encode(JSON.stringify(data));
                        
                        const options = {
                            challenge,
                            rpId: window.location.hostname === 'localhost' ? 'localhost' : window.location.hostname,
                            userVerification: "preferred",
                            allowCredentials: [{
                                type: "public-key",
                                id: credential.rawId
                            }],
                            timeout: 60000
                        };

                        const assertion = await navigator.credentials.get({
                            publicKey: options
                        });

                        if (!assertion) {
                            throw new Error("WebAuthn assertion failed");
                        }

                        return assertion.response;

                    } catch (error) {
                        throw error;
                    }
                };
            }

            async signWithDerivedKeys(data, credentialId, username, extra = []) {
                // Simplified version - in real implementation this would use derive.ts
                const authenticator = this.createAuthenticator(credentialId);
                await authenticator(data); // Verify user
                
                // Mock derived key signing
                const message = JSON.stringify(data);
                const mockSignature = await this.mockSign(message, credentialId);
                
                return 'SEA' + JSON.stringify({
                    m: message,
                    s: mockSignature
                });
            }

            async mockSign(message, credentialId) {
                // This is a mock - real implementation would use P-256 signing
                const encoder = new TextEncoder();
                const data = encoder.encode(message + credentialId);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = new Uint8Array(hashBuffer);
                return this.base64urlEncode(hashArray);
            }

            base64urlEncode(buffer) {
                const bytes = new Uint8Array(buffer);
                return btoa(String.fromCharCode(...bytes))
                    .replace(/\+/g, '-')
                    .replace(/\//g, '_')
                    .replace(/=/g, '');
            }

            listCredentials() {
                return Array.from(this.credentials.values());
            }

            getCredential(credentialId) {
                return this.credentials.get(credentialId);
            }
        }

        // Initialize signer
        webauthnSigner = new WebAuthnSignerDemo();

        // Utility functions
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // Example functions
        async function createSigningCredential() {
            const username = document.getElementById('username1').value;
            if (!username) {
                log('Please enter a username', 'error');
                return;
            }

            try {
                log(`Creating signing credential for: ${username}`);
                currentCredential = await webauthnSigner.createSigningCredential(username);
                
                document.getElementById('credential-output').innerHTML = 
                    `<div class="success">‚úÖ Credential created successfully!</div>
                     <pre>${JSON.stringify(currentCredential, null, 2)}</pre>`;
                
                document.getElementById('cred-id').textContent = currentCredential.id;
                document.getElementById('cred-pub').textContent = currentCredential.pub;
                document.getElementById('credential-info').style.display = 'block';
                
                // Enable other buttons
                document.getElementById('sign-btn').disabled = false;
                document.getElementById('derived-btn').disabled = false;
                document.getElementById('gun-btn').disabled = false;
                
                log(`Credential created: ${currentCredential.id}`, 'success');
                
            } catch (error) {
                log(`Error creating credential: ${error.message}`, 'error');
                document.getElementById('credential-output').innerHTML = 
                    `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function signWithAuthenticator() {
            if (!currentCredential) {
                log('Please create a credential first', 'error');
                return;
            }

            const data = document.getElementById('data-to-sign').value;
            
            try {
                log(`Creating authenticator for credential: ${currentCredential.id}`);
                currentAuthenticator = webauthnSigner.createAuthenticator(currentCredential.id);
                
                log(`Signing data: "${data}"`);
                
                // This simulates SEA.sign(data, authenticator)
                const response = await currentAuthenticator(data);
                
                document.getElementById('sign-output').innerHTML = 
                    `<div class="success">‚úÖ Data signed successfully with WebAuthn!</div>
                     <div><strong>Data:</strong> ${data}</div>
                     <div><strong>Credential ID:</strong> ${currentCredential.id}</div>
                     <div><strong>Public Key:</strong> ${currentCredential.pub}</div>
                     <div><strong>Response:</strong></div>
                     <pre>${JSON.stringify({
                         signature: response.signature ? 'Present' : 'None',
                         authenticatorData: 'Present',
                         clientDataJSON: 'Present'
                     }, null, 2)}</pre>`;
                
                log(`Data signed successfully with authenticator`, 'success');
                
            } catch (error) {
                log(`Error signing with authenticator: ${error.message}`, 'error');
                document.getElementById('sign-output').innerHTML = 
                    `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function signWithDerivedKeys() {
            if (!currentCredential) {
                log('Please create a credential first', 'error');
                return;
            }

            const data = document.getElementById('derived-data').value;
            
            try {
                log(`Signing with derived keys: "${data}"`);
                
                const signature = await webauthnSigner.signWithDerivedKeys(
                    data, 
                    currentCredential.id, 
                    currentCredential.username,
                    ['extra', 'entropy']
                );
                
                document.getElementById('derived-output').innerHTML = 
                    `<div class="success">‚úÖ Data signed with derived keys!</div>
                     <div><strong>Data:</strong> ${data}</div>
                     <div><strong>Signature:</strong></div>
                     <pre>${signature}</pre>`;
                
                log(`Derived key signature created`, 'success');
                
            } catch (error) {
                log(`Error signing with derived keys: ${error.message}`, 'error');
                document.getElementById('derived-output').innerHTML = 
                    `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function storeInGun() {
            if (!currentCredential) {
                log('Please create a credential first', 'error');
                return;
            }

            const data = document.getElementById('gun-data').value;
            
            try {
                log(`Storing data in Gun with signature: "${data}"`);
                
                // Sign the data first
                const signature = await webauthnSigner.signWithDerivedKeys(
                    data, 
                    currentCredential.id, 
                    currentCredential.username
                );
                
                // Store in Gun
                const userGraph = gun.get(`~${currentCredential.pub}`);
                userGraph.get('data').put(data);
                userGraph.get('signature').put(signature);
                userGraph.get('timestamp').put(Date.now());
                
                document.getElementById('gun-output').innerHTML = 
                    `<div class="success">‚úÖ Data stored in Gun with signature!</div>
                     <div><strong>Data:</strong> ${data}</div>
                     <div><strong>User Graph:</strong> ~${currentCredential.pub}</div>
                     <div><strong>Signature:</strong> ${signature.substring(0, 50)}...</div>`;
                
                log(`Data stored in Gun database`, 'success');
                
                // Try to read it back
                setTimeout(() => {
                    userGraph.get('data').once((storedData) => {
                        if (storedData) {
                            log(`Data read back from Gun: "${storedData}"`, 'success');
                        }
                    });
                }, 1000);
                
            } catch (error) {
                log(`Error storing in Gun: ${error.message}`, 'error');
                document.getElementById('gun-output').innerHTML = 
                    `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function multiDeviceDemo() {
            try {
                log('Starting multi-device demo...');
                
                // Create credentials for multiple "devices"
                const device1 = await webauthnSigner.createSigningCredential('alice-device1');
                const device2 = await webauthnSigner.createSigningCredential('alice-device2');
                
                const data = { action: 'transfer', amount: 100, timestamp: Date.now() };
                
                // Sign with both devices
                const sig1 = await webauthnSigner.signWithDerivedKeys(
                    data, device1.id, 'alice-device1'
                );
                
                const sig2 = await webauthnSigner.signWithDerivedKeys(
                    data, device2.id, 'alice-device2'
                );
                
                document.getElementById('multi-output').innerHTML = 
                    `<div class="success">‚úÖ Multi-device demo completed!</div>
                     <div><strong>Data:</strong> ${JSON.stringify(data)}</div>
                     <div><strong>Device 1 ID:</strong> ${device1.id}</div>
                     <div><strong>Device 1 Signature:</strong> ${sig1.substring(0, 50)}...</div>
                     <div><strong>Device 2 ID:</strong> ${device2.id}</div>
                     <div><strong>Device 2 Signature:</strong> ${sig2.substring(0, 50)}...</div>`;
                
                log(`Multi-device demo: Created 2 devices, signed same data`, 'success');
                
            } catch (error) {
                log(`Error in multi-device demo: ${error.message}`, 'error');
                document.getElementById('multi-output').innerHTML = 
                    `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        function listCredentials() {
            const credentials = webauthnSigner.listCredentials();
            log(`Total credentials: ${credentials.length}`);
            credentials.forEach((cred, index) => {
                log(`${index + 1}. ${cred.username} (${cred.id})`);
            });
        }

        // Check WebAuthn support
        if (window.PublicKeyCredential) {
            log('‚úÖ WebAuthn is supported in this browser', 'success');
        } else {
            log('‚ùå WebAuthn is not supported in this browser', 'error');
        }

        log('WebAuthn Oneshot Signing Demo loaded', 'success');
    </script>
</body>
</html> 