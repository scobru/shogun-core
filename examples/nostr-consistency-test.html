<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nostr Consistency Test - Shogun Core</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .normal { background: #e8f5e8; }
        .oneshot { background: #e8f0ff; }
        .consistency { background: #fff8e8; }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #005a87; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .result {
            background: #f9f9f9;
            padding: 10px;
            border-radius: 3px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success { border-left: 4px solid #4caf50; }
        .error { border-left: 4px solid #f44336; }
        .warning { border-left: 4px solid #ff9800; }
        input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            margin: 5px;
            width: 300px;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.warning { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Nostr Consistency Test</h1>
        <p>This test verifies that both normal and oneshot Nostr approaches create the <strong>same Gun user</strong>.</p>
        
        <div class="section">
            <h3>üìù Test Configuration</h3>
            <label>
                Nostr Address/PubKey:
                <input type="text" id="nostrAddress" placeholder="Enter Nostr public key or Bitcoin address" 
                       value="npub1234567890abcdef1234567890abcdef1234567890abcdef1234567890ab">
            </label>
            <br>
            <button onclick="clearResults()">Clear Results</button>
            <button onclick="runFullTest()">üöÄ Run Full Consistency Test</button>
        </div>

        <div class="section normal">
            <h3>üîÑ Normal Nostr Approach</h3>
            <p>Standard Nostr authentication that creates a Gun user with username + password from signature.</p>
            <button onclick="testNormalApproach()">Test Normal Approach</button>
            <div id="normalResult" class="result"></div>
        </div>

        <div class="section oneshot">
            <h3>‚ö° Oneshot Nostr Approach</h3>
            <p>Operation-level signing using derive.ts with the SAME password generation as normal approach.</p>
            <button onclick="testOneshotApproach()">Test Oneshot Approach</button>
            <div id="oneshotResult" class="result"></div>
        </div>

        <div class="section consistency">
            <h3>‚úÖ Consistency Verification</h3>
            <p>Verifies that both approaches create the same Gun user.</p>
            <button onclick="verifyConsistency()">Verify Consistency</button>
            <div id="consistencyResult" class="result"></div>
        </div>

        <div id="overallStatus" class="status" style="display: none;"></div>
    </div>

    <script type="module">
        // Mock implementations for testing
        // In a real implementation, these would use the actual Nostr plugin

        let normalResult = null;
        let oneshotResult = null;

        // Mock Nostr connector
        class MockNostrConnector {
            async generateCredentials(address) {
                // Simulate the same approach as the real NostrConnector
                const signature = await this.generateDeterministicSignature(address);
                const username = address.toLowerCase();
                const password = await this.generatePassword(signature);
                
                return {
                    username,
                    password,
                    signature,
                    message: "I Love Shogun!"
                };
            }

            async generateDeterministicSignature(address) {
                const baseString = `${address}_I Love Shogun!_shogun_deterministic`;
                let hash = "";
                let runningValue = 0;

                for (let i = 0; i < baseString.length; i++) {
                    const charCode = baseString.charCodeAt(i);
                    runningValue = (runningValue * 31 + charCode) & 0xffffffff;

                    if (i % 4 === 3) {
                        hash += runningValue.toString(16).padStart(8, "0");
                    }
                }

                while (hash.length < 128) {
                    runningValue = (runningValue * 31 + hash.length) & 0xffffffff;
                    hash += runningValue.toString(16).padStart(8, "0");
                }

                let deterministicSignature = hash.substring(0, 128);
                deterministicSignature = deterministicSignature.toLowerCase().replace(/[^0-9a-f]/g, "0");

                if (deterministicSignature.length < 128) {
                    deterministicSignature = deterministicSignature.padEnd(128, "0");
                } else if (deterministicSignature.length > 128) {
                    deterministicSignature = deterministicSignature.substring(0, 128);
                }

                return deterministicSignature;
            }

            async generatePassword(signature) {
                const normalizedSig = signature.toLowerCase().replace(/[^a-f0-9]/g, "");
                let hash = "";
                let runningValue = 0;

                for (let i = 0; i < normalizedSig.length; i++) {
                    const charCode = normalizedSig.charCodeAt(i);
                    runningValue = (runningValue * 31 + charCode) & 0xffffffff;

                    if (i % 8 === 7) {
                        hash += runningValue.toString(16).padStart(8, "0");
                    }
                }

                while (hash.length < 64) {
                    runningValue = (runningValue * 31 + hash.length) & 0xffffffff;
                    hash += runningValue.toString(16).padStart(8, "0");
                }

                return hash.substring(0, 64);
            }
        }

        // Mock Nostr signer
        class MockNostrSigner {
            constructor() {
                this.connector = new MockNostrConnector();
            }

            async createSigningCredential(address) {
                // Use the SAME approach as normal Nostr
                const credentials = await this.connector.generateCredentials(address);
                
                return {
                    address,
                    signature: credentials.signature,
                    message: credentials.message,
                    username: credentials.username,
                    password: credentials.password // This is the key consistency point!
                };
            }

            async createDerivedKeyPair(address) {
                const credential = await this.createSigningCredential(address);
                
                // Mock derive function using password as seed
                const seed = credential.password;
                const mockPub = `derived_pub_${seed.substring(0, 16)}`;
                const mockPriv = `derived_priv_${seed.substring(16, 32)}`;
                
                return {
                    pub: mockPub,
                    priv: mockPriv,
                    epub: `e${mockPub}`,
                    epriv: `e${mockPriv}`
                };
            }
        }

        const mockConnector = new MockNostrConnector();
        const mockSigner = new MockNostrSigner();

        window.testNormalApproach = async function() {
            const address = document.getElementById('nostrAddress').value;
            const resultDiv = document.getElementById('normalResult');
            
            try {
                resultDiv.textContent = 'Testing normal Nostr approach...';
                
                // Simulate normal approach
                const credentials = await mockConnector.generateCredentials(address);
                
                // Mock Gun user creation
                const gunUserPub = `gun_user_${credentials.password.substring(0, 16)}`;
                
                normalResult = {
                    approach: 'normal',
                    address,
                    username: credentials.username,
                    password: credentials.password,
                    signature: credentials.signature,
                    gunUserPub,
                    timestamp: new Date().toISOString()
                };
                
                resultDiv.className = 'result success';
                resultDiv.textContent = `‚úÖ Normal Approach Success:
Address: ${address}
Username: ${credentials.username}
Password: ${credentials.password.substring(0, 16)}...
Signature: ${credentials.signature.substring(0, 32)}...
Gun User Pub: ${gunUserPub}
Message: ${credentials.message}`;
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Normal Approach Error: ${error.message}`;
            }
        };

        window.testOneshotApproach = async function() {
            const address = document.getElementById('nostrAddress').value;
            const resultDiv = document.getElementById('oneshotResult');
            
            try {
                resultDiv.textContent = 'Testing oneshot Nostr approach...';
                
                // Simulate oneshot approach
                const credential = await mockSigner.createSigningCredential(address);
                const derivedKeys = await mockSigner.createDerivedKeyPair(address);
                
                oneshotResult = {
                    approach: 'oneshot',
                    address,
                    username: credential.username,
                    password: credential.password, // Same as normal!
                    signature: credential.signature,
                    derivedPub: derivedKeys.pub,
                    derivedPriv: derivedKeys.priv,
                    gunUserPub: `gun_user_${credential.password.substring(0, 16)}`, // Same as normal!
                    timestamp: new Date().toISOString()
                };
                
                resultDiv.className = 'result success';
                resultDiv.textContent = `‚ö° Oneshot Approach Success:
Address: ${address}
Username: ${credential.username}
Password: ${credential.password.substring(0, 16)}... (SAME as normal!)
Signature: ${credential.signature.substring(0, 32)}...
Derived Pub: ${derivedKeys.pub}
Gun User Pub: ${oneshotResult.gunUserPub} (SAME as normal!)
Message: ${credential.message}`;
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Oneshot Approach Error: ${error.message}`;
            }
        };

        window.verifyConsistency = function() {
            const resultDiv = document.getElementById('consistencyResult');
            const statusDiv = document.getElementById('overallStatus');
            
            if (!normalResult || !oneshotResult) {
                resultDiv.className = 'result warning';
                resultDiv.textContent = '‚ö†Ô∏è Please run both normal and oneshot tests first.';
                return;
            }
            
            try {
                const checks = {
                    sameAddress: normalResult.address === oneshotResult.address,
                    sameUsername: normalResult.username === oneshotResult.username,
                    samePassword: normalResult.password === oneshotResult.password,
                    sameSignature: normalResult.signature === oneshotResult.signature,
                    sameGunUser: normalResult.gunUserPub === oneshotResult.gunUserPub
                };
                
                const allConsistent = Object.values(checks).every(check => check);
                
                let resultText = `üîç Consistency Check Results:
Same Address: ${checks.sameAddress ? '‚úÖ' : '‚ùå'}
Same Username: ${checks.sameUsername ? '‚úÖ' : '‚ùå'}
Same Password: ${checks.samePassword ? '‚úÖ' : '‚ùå'} (CRITICAL)
Same Signature: ${checks.sameSignature ? '‚úÖ' : '‚ùå'}
Same Gun User: ${checks.sameGunUser ? '‚úÖ' : '‚ùå'} (CRITICAL)

Overall Consistency: ${allConsistent ? '‚úÖ CONSISTENT' : '‚ùå INCONSISTENT'}`;
                
                if (allConsistent) {
                    resultDiv.className = 'result success';
                    statusDiv.className = 'status success';
                    statusDiv.textContent = 'üéâ SUCCESS: Both approaches create the SAME Gun user!';
                    statusDiv.style.display = 'block';
                } else {
                    resultDiv.className = 'result error';
                    statusDiv.className = 'status error';
                    statusDiv.textContent = '‚ùå FAILURE: Approaches create DIFFERENT Gun users!';
                    statusDiv.style.display = 'block';
                }
                
                resultDiv.textContent = resultText;
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Consistency Check Error: ${error.message}`;
            }
        };

        window.runFullTest = async function() {
            const statusDiv = document.getElementById('overallStatus');
            statusDiv.style.display = 'block';
            statusDiv.className = 'status warning';
            statusDiv.textContent = 'üîÑ Running full consistency test...';
            
            await testNormalApproach();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testOneshotApproach();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            verifyConsistency();
        };

        window.clearResults = function() {
            document.getElementById('normalResult').textContent = '';
            document.getElementById('oneshotResult').textContent = '';
            document.getElementById('consistencyResult').textContent = '';
            document.getElementById('overallStatus').style.display = 'none';
            normalResult = null;
            oneshotResult = null;
        };

        // Auto-run test on page load
        setTimeout(() => {
            runFullTest();
        }, 1000);
    </script>
</body>
</html> 