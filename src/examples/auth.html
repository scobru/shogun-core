<!doctype html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Shogun Auth</title>
    <link rel="stylesheet" href="shogun.css" />
  </head>

  <body>
    <div class="container">
      <div class="app-header">
        <div class="app-title">Shogun Auth</div>
      </div>

      <div class="action-group">
        <h2>Inizializzazione</h2>
        <button id="initBtn" type="button" class="primary-button">
          Inizializza Shogun
        </button>
        <button id="testGunBtn" type="button" class="primary-button">
          Test Gun Connection
        </button>
        <div id="supportStatus"></div>
      </div>

      <div class="action-group">
        <h2>Autenticazione</h2>

        <div class="auth-methods">
          <!-- Username e Password -->
          <div class="auth-method">
            <h3>Username e Password</h3>
            <form id="loginForm" onsubmit="return false;">
              <div class="form-group">
                <input
                  type="text"
                  id="username"
                  placeholder="Username"
                  autocomplete="username"
                />
              </div>
              <div class="form-group">
                <input
                  type="password"
                  id="password"
                  placeholder="Password"
                  autocomplete="current-password"
                />
              </div>
              <div class="form-actions">
                <button
                  type="button"
                  id="loginBtn"
                  type="button"
                  class="action-button"
                >
                  Login
                </button>
                <button
                  type="button"
                  id="signupBtn"
                  type="button"
                  class="action-button"
                >
                  Registrati
                </button>
              </div>
            </form>
          </div>

          <!-- WebAuthn -->
          <div class="auth-method">
            <h3>
              WebAuthn <span id="webauthnStatus" class="status-badge"></span>
            </h3>
            <form id="webauthnForm" onsubmit="return false;">
              <div class="form-group">
                <input
                  type="text"
                  id="webauthnUsername"
                  placeholder="Username per WebAuthn"
                  autocomplete="username"
                />
              </div>
              <div class="form-actions">
                <button type="button" id="webauthnLoginBtn" disabled>
                  Login con WebAuthn
                </button>
                <button type="button" id="webauthnSignupBtn" disabled>
                  Registra con WebAuthn
                </button>
              </div>
            </form>
          </div>

          <!-- MetaMask -->
          <div class="auth-method">
            <h3>
              MetaMask <span id="metamaskStatus" class="status-badge"></span>
            </h3>
            <div id="metamaskAddress" class="user-id mb-2">
              Indirizzo non rilevato
            </div>
            <div class="form-actions">
              <button id="metamaskConnectBtn">Connetti MetaMask</button>
              <button id="metamaskLoginBtn">Login con MetaMask</button>
              <button id="metamaskSignupBtn">Registra con MetaMask</button>
            </div>
          </div>

          <!-- Bitcoin Wallet -->
          <div class="auth-method">
            <h3>
              Bitcoin Wallet
              <span id="bitcoinStatus" class="status-badge"></span>
            </h3>
            <div id="bitcoinAddress" class="user-id mb-2">
              Indirizzo non rilevato
            </div>
            <div class="form-actions">
              <select id="bitcoinWalletType">
                <option value="nostr">Nostr</option>
                <option value="manual">Manuale</option>
              </select>
              <button id="bitcoinConnectBtn">Connetti Wallet</button>
              <button id="bitcoinLoginBtn">Login con Bitcoin</button>
              <button id="bitcoinSignupBtn">Registra con Bitcoin</button>
            </div>
            <!-- Sezione per la connessione manuale -->
            <div
              id="bitcoinManualSection"
              style="display: none; margin-top: 10px"
            >
              <div class="form-group">
                <input
                  type="text"
                  id="bitcoinManualAddress"
                  placeholder="Indirizzo Bitcoin"
                />
              </div>
              <div class="form-group">
                <input
                  type="password"
                  id="bitcoinManualPrivateKey"
                  placeholder="Chiave privata (opzionale)"
                />
              </div>
            </div>
          </div>
        </div>

        <div class="mt-2">
          <button id="logoutBtn" type="button" class="action-button">
            Logout
          </button>
        </div>
      </div>

      <div class="action-group">
        <h2>Wallet</h2>
        <div class="form-actions">
          <button id="createWalletBtn" type="button" class="action-button">
            Crea Wallet
          </button>
          <button id="getWalletsBtn" type="button" class="action-button">
            Ottieni Wallets
          </button>
        </div>
      </div>

      <div id="results">I risultati appariranno qui...</div>
    </div>

    <!-- Includi la libreria Shogun Core dalla directory dist/browser -->
    <script src="../../dist/browser/shogun-core.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/dist/gun.js" defer></script>
    <script
      src="https://cdn.jsdelivr.net/npm/gun/dist/lib/wire.js"
      defer
    ></script>

    <script>
      // Riferimenti agli elementi DOM
      const initBtn = document.getElementById("initBtn");
      const loginBtn = document.getElementById("loginBtn");
      const signupBtn = document.getElementById("signupBtn");
      const logoutBtn = document.getElementById("logoutBtn");
      const createWalletBtn = document.getElementById("createWalletBtn");
      const getWalletsBtn = document.getElementById("getWalletsBtn");
      const usernameInput = document.getElementById("username");
      const passwordInput = document.getElementById("password");
      const resultsDiv = document.getElementById("results");
      const supportStatusDiv = document.getElementById("supportStatus");

      // Elementi WebAuthn
      const webauthnStatusSpan = document.getElementById("webauthnStatus");
      const webauthnUsernameInput = document.getElementById("webauthnUsername");
      const webauthnLoginBtn = document.getElementById("webauthnLoginBtn");
      const webauthnSignupBtn = document.getElementById("webauthnSignupBtn");

      // Elementi MetaMask
      const metamaskStatusSpan = document.getElementById("metamaskStatus");
      const metamaskAddressDiv = document.getElementById("metamaskAddress");
      const metamaskConnectBtn = document.getElementById("metamaskConnectBtn");
      const metamaskLoginBtn = document.getElementById("metamaskLoginBtn");
      const metamaskSignupBtn = document.getElementById("metamaskSignupBtn");

      // Elementi Bitcoin Wallet
      const bitcoinStatusSpan = document.getElementById("bitcoinStatus");
      const bitcoinAddressDiv = document.getElementById("bitcoinAddress");
      const bitcoinWalletTypeSelect =
        document.getElementById("bitcoinWalletType");
      const bitcoinConnectBtn = document.getElementById("bitcoinConnectBtn");
      const bitcoinLoginBtn = document.getElementById("bitcoinLoginBtn");
      const bitcoinSignupBtn = document.getElementById("bitcoinSignupBtn");
      const bitcoinManualSection = document.getElementById(
        "bitcoinManualSection"
      );
      const bitcoinManualAddress = document.getElementById(
        "bitcoinManualAddress"
      );
      const bitcoinManualPrivateKey = document.getElementById(
        "bitcoinManualPrivateKey"
      );

      // Variabili globali
      let shogun;
      let metamaskAddress = "";
      let bitcoinAddress = "";

      // Plugin
      let webauthnPlugin;
      let metamaskPlugin;
      let bitcoinPlugin;
      let bip32Plugin;

      // Funzione per mostrare i risultati
      function showResult(title, data) {
        resultsDiv.innerHTML = `<strong>${title}</strong>\n\n${JSON.stringify(data, null, 2)}`;
      }

      // Funzione per mostrare errori
      function showError(title, error) {
        resultsDiv.innerHTML = `<strong>${title} - ERRORE</strong>\n\n${error.message || error}`;
        console.error(error);
      }

      // Funzione per verificare il supporto a WebAuthn
      function checkWebAuthnSupport() {
        if (!webauthnPlugin) {
          webauthnStatusSpan.textContent = "NON INIZIALIZZATO";
          webauthnStatusSpan.className = "status-badge status-not-supported";
          webauthnLoginBtn.disabled = true;
          webauthnSignupBtn.disabled = true;
          return false;
        }

        try {
          // Controlla se WebAuthn è supportato dal browser
          const isSupported = typeof window.PublicKeyCredential !== "undefined";
          webauthnStatusSpan.textContent = isSupported
            ? "SUPPORTATO"
            : "NON SUPPORTATO";
          webauthnStatusSpan.className = `status-badge ${isSupported ? "status-supported" : "status-not-supported"}`;
          webauthnLoginBtn.disabled = !isSupported;
          webauthnSignupBtn.disabled = !isSupported;
          return isSupported;
        } catch (error) {
          console.error(
            "Errore durante il controllo del supporto WebAuthn:",
            error
          );
          webauthnStatusSpan.textContent = "ERRORE";
          webauthnStatusSpan.className = "status-badge status-not-supported";
          webauthnLoginBtn.disabled = true;
          webauthnSignupBtn.disabled = true;
          return false;
        }
      }

      // Funzione per verificare il supporto a MetaMask
      function checkEthereumSupport() {
        if (!metamaskPlugin) {
          metamaskStatusSpan.textContent = "NON INIZIALIZZATO";
          metamaskStatusSpan.className = "status-badge status-not-supported";
          metamaskConnectBtn.disabled = true;
          return false;
        }

        try {
          // Verifica direttamente se ethereum è disponibile nel browser
          const isAvailable = typeof window.ethereum !== "undefined";
          metamaskStatusSpan.textContent = isAvailable
            ? "RILEVATO"
            : "NON RILEVATO";
          metamaskStatusSpan.className = `status-badge ${isAvailable ? "status-supported" : "status-not-supported"}`;
          metamaskConnectBtn.disabled = !isAvailable;
          return isAvailable;
        } catch (error) {
          console.error(
            "Errore durante il controllo del supporto Ethereum:",
            error
          );
          metamaskStatusSpan.textContent = "ERRORE";
          metamaskStatusSpan.className = "status-badge status-not-supported";
          metamaskConnectBtn.disabled = true;
          return false;
        }
      }

      // Funzione per verificare il supporto a Bitcoin Wallet
      function checkBitcoinSupport() {
        if (!bitcoinPlugin) {
          bitcoinStatusSpan.textContent = "NON INIZIALIZZATO";
          bitcoinStatusSpan.className = "status-badge status-not-supported";
          bitcoinConnectBtn.disabled = true;
          return false;
        }

        try {
          // Verifica se Nostr è disponibile nel browser
          const nostrAvailable = typeof window.nostr !== "undefined";

          // Se il plugin bitcoin ha un metodo per verificare la disponibilità di Nostr, usiamolo
          let pluginNostrAvailable = false;
          if (typeof bitcoinPlugin.isNostrExtensionAvailable === "function") {
            pluginNostrAvailable = bitcoinPlugin.isNostrExtensionAvailable();
          }

          const isAvailable = nostrAvailable || pluginNostrAvailable || true; // Consideriamo sempre disponibile per la modalità manuale
          const supportText = isAvailable
            ? nostrAvailable || pluginNostrAvailable
              ? "Nostr"
              : "Manuale"
            : "NON DISPONIBILE";

          bitcoinStatusSpan.textContent = supportText;
          bitcoinStatusSpan.className = `status-badge ${isAvailable ? "status-supported" : "status-not-supported"}`;

          bitcoinConnectBtn.disabled = !isAvailable;
          bitcoinLoginBtn.disabled = !isAvailable || !bitcoinAddress;
          bitcoinSignupBtn.disabled = !isAvailable || !bitcoinAddress;

          return isAvailable;
        } catch (error) {
          console.error(
            "Errore durante il controllo del supporto Bitcoin:",
            error
          );
          bitcoinStatusSpan.textContent = "ERRORE";
          bitcoinStatusSpan.className = "status-badge status-not-supported";
          bitcoinConnectBtn.disabled = true;
          return false;
        }
      }

      // Funzione per connettersi a MetaMask
      async function connectMetaMask() {
        try {
          if (!metamaskPlugin) {
            showError("MetaMask", "Plugin MetaMask non disponibile");
            return;
          }

          const result = await metamaskPlugin.connectMetaMask();

          if (result.success) {
            metamaskAddress = result.address;
            metamaskAddressDiv.textContent = `Indirizzo: ${metamaskAddress}`;
            showResult("MetaMask Connesso", result);

            // Abilita i pulsanti di login e registrazione
            metamaskLoginBtn.disabled = false;
            metamaskSignupBtn.disabled = false;
          } else {
            showError(
              "MetaMask",
              result.error || "Errore durante la connessione"
            );
          }
        } catch (error) {
          showError("MetaMask", error);
        }
      }

      // Funzione per connettersi a Bitcoin Wallet
      async function connectBitcoinWallet() {
        try {
          if (!bitcoinPlugin) {
            showError("Bitcoin Wallet", "Plugin Bitcoin non disponibile");
            return;
          }

          console.log(bitcoinPlugin);

          const walletType = bitcoinWalletTypeSelect.value;

          // Se l'utente sceglie l'opzione manuale, mostra i campi di input
          if (walletType === "manual") {
            bitcoinManualSection.style.display = "block";

            // Se l'indirizzo manuale è già stato inserito, procedi con la connessione
            if (bitcoinManualAddress.value) {
              const manualAddress = bitcoinManualAddress.value;
              bitcoinAddress = manualAddress;
              bitcoinAddressDiv.textContent = `Indirizzo: ${bitcoinAddress}`;
              bitcoinLoginBtn.disabled = false;
              bitcoinSignupBtn.disabled = false;

              showResult("Bitcoin Wallet", {
                success: true,
                message: "Indirizzo Bitcoin manuale configurato",
                address: bitcoinAddress,
              });
            }
            return;
          } else {
            bitcoinManualSection.style.display = "none";
          }

          // Usa il metodo appropriato per la connessione (connectWallet o connect)
          let result;

          result = await bitcoinPlugin.connectBitcoinWallet(walletType);

          if (result.success) {
            bitcoinAddress = result.address;
            bitcoinAddressDiv.textContent = `Indirizzo: ${bitcoinAddress}`;
            bitcoinLoginBtn.disabled = false;
            bitcoinSignupBtn.disabled = false;
            showResult("Bitcoin Wallet Connesso", result);
          } else {
            showError(
              "Bitcoin Wallet",
              result.error || "Errore durante la connessione"
            );
          }
        } catch (error) {
          showError("Bitcoin Wallet", error);
        }
      }

      // Inizializzazione di Shogun
      initBtn.addEventListener("click", async function (e) {
        e.preventDefault();

        try {
          // Configurazione Gun
          const options = {
            peers: ["http://localhost:8765/gun"],
            localStorage: false,
            radisk: false,
            wire: true,
          };

          // Configurazione per l'ambiente browser
          const config = {
            gunInstance: new Gun(options),
            appScope: "shogun",
            peers: ["http://localhost:8765/gun"],
            webauthn: {
              enabled: true,
              rpName: "Shogun Demo",
              rpId: window.location.hostname,
            },
            ethereum: {
              enabled: true,
            },
            bitcoin: {
              enabled: true,
              network: "mainnet",
              defaultWalletType: "nostr",
            },
            bip44: {
              enabled: true,
            },
            logging: {
              enabled: true,
              level: "debug",
              prefix: "[Shogun Demo]",
            },
          };

          // Utilizziamo la funzione di inizializzazione specifica per browser
          shogun = window.initShogunBrowser(config);

          shogun.gun.on("out", function (msg) {
            var to = this.to;
            // Adds headers for put
            msg.headers = {
              token: "automa25",
            };
            to.next(msg); // pass to next middleware
          });

          // Otteniamo i riferimenti ai plugin direttamente
          webauthnPlugin = shogun.getPlugin("webauthn");
          metamaskPlugin = shogun.getPlugin("ethereum");
          bitcoinPlugin = shogun.getPlugin("bitcoin"); // Nota: il nome potrebbe essere "bitcoin-wallet" invece di "bitcoin"
          bip32Plugin = shogun.getPlugin("hdwallet"); // Fix: use correct plugin name

          // Verifica il supporto delle tecnologie
          const webauthnSupported = checkWebAuthnSupport();
          const ethereumSupported = checkEthereumSupport();
          const bitcoinSupported = checkBitcoinSupport();

          // Make the shogun instance available globally
          window.shogun = shogun;
          console.log("Shogun initialized and exposed globally");

          showResult("Shogun Inizializzato", {
            stato: "Successo",
            connesso: true,
            webauthn: webauthnSupported,
            ethereum: ethereumSupported,
            bitcoin: bitcoinSupported,
            plugins: {
              webauthn: !!webauthnPlugin,
              ethereum: !!metamaskPlugin,
              bitcoin: !!bitcoinPlugin,
              bip44: !!bip32Plugin,
            },
          });
        } catch (error) {
          showError("Inizializzazione", error);
        }
      });

      // Login con username e password
      loginBtn.addEventListener("click", async function (e) {
        e.preventDefault();

        if (!shogun) {
          showError("Login", new Error("Shogun non è stato inizializzato!"));
          return;
        }

        try {
          const username = usernameInput.value;
          const password = passwordInput.value;

          if (!username || !password) {
            showError(
              "Login",
              new Error("Username e password sono richiesti!")
            );
            return;
          }

          showResult("Login", { message: "Login in corso...", username });
          const result = await shogun.login(username, password);

          if (result.success) {
            showResult("Login completato", result);
          } else {
            showError("Login", new Error(result.error || "Login fallito"));
          }
        } catch (error) {
          showError("Login", error);
        }
      });

      // Registrazione con username e password
      signupBtn.addEventListener("click", async function (e) {
        e.preventDefault();

        if (!shogun) {
          showError(
            "Registrazione",
            new Error("Shogun non è stato inizializzato!")
          );
          return;
        }

        try {
          const username = usernameInput.value;
          const password = passwordInput.value;

          if (!username || !password) {
            showError(
              "Registrazione",
              new Error("Username e password sono richiesti!")
            );
            return;
          }

          showResult("Registrazione", {
            message: "Registrazione in corso...",
            username,
          });
          const result = await shogun.signUp(username, password);

          if (result.success) {
            showResult("Registrazione completata", result);
          } else {
            showError(
              "Registrazione",
              new Error(result.error || "Registrazione fallita")
            );
          }
        } catch (error) {
          showError("Registrazione", error);
        }
      });

      // Logout
      logoutBtn.addEventListener("click", function (e) {
        e.preventDefault();

        if (!shogun) {
          showError("Logout", new Error("Shogun non è stato inizializzato!"));
          return;
        }

        try {
          // Check if user is logged in
          if (!shogun.isLoggedIn()) {
            showResult("Logout", {
              success: true,
              message: "Nessun utente connesso, logout non necessario",
            });
            return;
          }

          // Logout
          shogun.logout();
          showResult("Logout", {
            success: true,
            message: "Utente disconnesso con successo",
          });
        } catch (error) {
          showError("Logout", error);
        }
      });

      // Collegamento a MetaMask
      metamaskConnectBtn.addEventListener("click", async function (e) {
        e.preventDefault();
        await connectMetaMask();
      });

      // Login con MetaMask
      metamaskLoginBtn.addEventListener("click", async function (e) {
        e.preventDefault();

        if (!shogun) {
          showError(
            "Login MetaMask",
            new Error("Shogun non è stato inizializzato!")
          );
          return;
        }

        if (!metamaskPlugin) {
          showError(
            "Login MetaMask",
            new Error("Plugin MetaMask non disponibile")
          );
          return;
        }

        try {
          // Prima connettiti a MetaMask se non lo siamo già
          if (!metamaskAddress) {
            showResult("MetaMask", {
              message: "Connessione a MetaMask in corso...",
            });
            const connectResult = await metamaskPlugin.connectMetaMask();

            if (!connectResult.success) {
              showError(
                "Connessione MetaMask",
                new Error(
                  connectResult.error ||
                    "Errore durante la connessione a MetaMask"
                )
              );
              return;
            }

            metamaskAddress = connectResult.address;
            metamaskAddressDiv.textContent = `Indirizzo: ${metamaskAddress}`;
          }

          showResult("MetaMask", {
            message: "Login in corso...",
            address: metamaskAddress,
          });

          // Usa il metodo appropriato per il login
          let result;
          if (typeof metamaskPlugin.loginWithMetaMask === "function") {
            result = await metamaskPlugin.loginWithMetaMask(metamaskAddress);
          } else if (typeof metamaskPlugin.login === "function") {
            result = await metamaskPlugin.login(metamaskAddress);
          } else {
            throw new Error("Metodo di login non disponibile");
          }

          if (result.success) {
            showResult("Login con MetaMask completato", result);
          } else {
            showError(
              "Login MetaMask",
              new Error(result.error || "Errore durante il login")
            );
          }
        } catch (error) {
          showError("Login MetaMask", error);
        }
      });

      // Registrazione con MetaMask
      metamaskSignupBtn.addEventListener("click", async function (e) {
        e.preventDefault();

        if (!shogun) {
          showError(
            "Registrazione MetaMask",
            new Error("Shogun non è stato inizializzato!")
          );
          return;
        }

        if (!metamaskPlugin) {
          showError(
            "Registrazione MetaMask",
            new Error("Plugin MetaMask non disponibile")
          );
          return;
        }

        try {
          // Prima connettiti a MetaMask se non lo siamo già
          if (!metamaskAddress) {
            showResult("MetaMask", {
              message: "Connessione a MetaMask in corso...",
            });
            const connectResult = await metamaskPlugin.connectMetaMask();

            if (!connectResult.success) {
              showError(
                "Connessione MetaMask",
                new Error(
                  connectResult.error ||
                    "Errore durante la connessione a MetaMask"
                )
              );
              return;
            }

            metamaskAddress = connectResult.address;
            metamaskAddressDiv.textContent = `Indirizzo: ${metamaskAddress}`;
          }

          showResult("MetaMask", {
            message: "Registrazione in corso...",
            address: metamaskAddress,
          });

          // Usa il metodo appropriato per la registrazione
          let result;
          if (typeof metamaskPlugin.signUpWithMetaMask === "function") {
            result = await metamaskPlugin.signUpWithMetaMask(metamaskAddress);
          } else if (typeof metamaskPlugin.signUp === "function") {
            result = await metamaskPlugin.signUp(metamaskAddress);
          } else {
            throw new Error("Metodo di registrazione non disponibile");
          }

          if (result.success) {
            showResult("Registrazione con MetaMask completata", result);
          } else {
            showError(
              "Registrazione MetaMask",
              new Error(result.error || "Errore durante la registrazione")
            );
          }
        } catch (error) {
          showError("Registrazione MetaMask", error);
        }
      });

      // Login con WebAuthn
      webauthnLoginBtn.addEventListener("click", async function (e) {
        e.preventDefault();

        if (!shogun) {
          showError(
            "Login WebAuthn",
            new Error("Shogun non è stato inizializzato!")
          );
          return;
        }

        if (!webauthnPlugin) {
          showError(
            "Login WebAuthn",
            new Error("Plugin WebAuthn non disponibile")
          );
          return;
        }

        const username = webauthnUsernameInput.value;
        if (!username) {
          showError(
            "Login WebAuthn",
            new Error("Username richiesto per WebAuthn!")
          );
          return;
        }

        try {
          showResult("WebAuthn", { message: "Login in corso...", username });

          // Usa il metodo appropriato per il login
          let result;
          if (typeof webauthnPlugin.loginWithWebAuthn === "function") {
            result = await webauthnPlugin.loginWithWebAuthn(username);
          } else if (typeof webauthnPlugin.login === "function") {
            result = await webauthnPlugin.login(username);
          } else {
            throw new Error("Metodo di login non disponibile");
          }

          if (result.success) {
            showResult("Login con WebAuthn completato", result);
          } else {
            showError(
              "Login WebAuthn",
              new Error(result.error || "Login fallito")
            );
          }
        } catch (error) {
          showError("Login WebAuthn", error);
        }
      });

      // Registrazione con WebAuthn
      webauthnSignupBtn.addEventListener("click", async function (e) {
        e.preventDefault();

        if (!shogun) {
          showError(
            "Registrazione WebAuthn",
            new Error("Shogun non è stato inizializzato!")
          );
          return;
        }

        if (!webauthnPlugin) {
          showError(
            "Registrazione WebAuthn",
            new Error("Plugin WebAuthn non disponibile")
          );
          return;
        }

        const username = webauthnUsernameInput.value;
        if (!username) {
          showError(
            "Registrazione WebAuthn",
            new Error("Username richiesto per WebAuthn!")
          );
          return;
        }

        try {
          showResult("WebAuthn", {
            message: "Registrazione in corso...",
            username,
          });

          // Usa il metodo appropriato per la registrazione
          let result;
          if (typeof webauthnPlugin.signUpWithWebAuthn === "function") {
            result = await webauthnPlugin.signUpWithWebAuthn(username);
          } else if (typeof webauthnPlugin.signUp === "function") {
            result = await webauthnPlugin.signUp(username);
          } else {
            throw new Error("Metodo di registrazione non disponibile");
          }

          if (result.success) {
            showResult("Registrazione con WebAuthn completata", result);
          } else {
            showError(
              "Registrazione WebAuthn",
              new Error(result.error || "Registrazione fallita")
            );
          }
        } catch (error) {
          showError("Registrazione WebAuthn", error);
        }
      });

      // Collegamento a Bitcoin Wallet
      bitcoinConnectBtn.addEventListener("click", async function (e) {
        e.preventDefault();
        await connectBitcoinWallet();
      });

      // Login con Bitcoin
      bitcoinLoginBtn.addEventListener("click", async function (e) {
        e.preventDefault();

        if (!shogun) {
          showError(
            "Login Bitcoin",
            new Error("Shogun non è stato inizializzato!")
          );
          return;
        }

        if (!bitcoinPlugin) {
          showError(
            "Login Bitcoin",
            new Error("Plugin Bitcoin non disponibile")
          );
          return;
        }

        if (!bitcoinAddress) {
          showError(
            "Login Bitcoin",
            new Error("Nessun indirizzo Bitcoin configurato")
          );
          return;
        }

        try {
          showResult("Bitcoin Wallet", {
            message: "Login in corso...",
            address: bitcoinAddress,
          });

          // Ottieni l'alias salvato dalla registrazione, se disponibile
          let alias = localStorage.getItem("bitcoin_user_alias");

          // Se l'alias non è disponibile, creiamo un alias di fallback basato sull'indirizzo
          if (!alias) {
            // Crea un alias basato sull'indirizzo - questo è un tentativo di fallback
            alias = `btc_user_fallback_${bitcoinAddress.substring(0, 6)}`;
            console.log(
              "Nessun alias trovato in localStorage, usando fallback:",
              alias
            );
          } else {
            console.log("Alias trovato in localStorage:", alias);
          }

          // Ottieni l'opzione del wallet type
          const walletType = bitcoinWalletTypeSelect.value;

          // Prepara opzioni aggiuntive
          const options = {
            walletType,
            alias,
            forceConnect: true, // Forza la riconnessione
            debug: true, // Abilita log aggiuntivi
          };

          console.log("Login Bitcoin con opzioni:", options);

          // Usa il metodo appropriato per il login
          let result;
          if (typeof bitcoinPlugin.login === "function") {
            result = await bitcoinPlugin.login(bitcoinAddress, options);
          } else {
            throw new Error("Metodo di login non disponibile");
          }

          if (result.success) {
            showResult("Login con Bitcoin completato", result);
          } else {
            // Se il login fallisce, potrebbe essere necessario provare con un alias diverso
            if (
              result.error &&
              result.error.includes("Wrong user or password")
            ) {
              // Prova ad elencare alcuni alias possibili per l'utente
              const alternativeAlias = `btc_user_alternative_${bitcoinAddress.substring(0, 6)}`;

              // Mostra un messaggio più dettagliato con suggerimenti
              const detailedError = new Error(
                `${result.error || "Login fallito"} (con opzioni: ${JSON.stringify(options)})\n\n` +
                  `Suggerimenti:\n` +
                  `1. Prova a registrarti nuovamente\n` +
                  `2. Pulisci localStorage con 'localStorage.clear()' e riprova\n` +
                  `3. Prova ad usare un alias alternativo: ${alternativeAlias}`
              );
              showError("Login Bitcoin", detailedError);
            } else {
              // Mostra un errore più dettagliato con le opzioni tentate
              const detailedError = new Error(
                `${result.error || "Login fallito"} (con opzioni: ${JSON.stringify(options)})`
              );
              showError("Login Bitcoin", detailedError);
            }
          }
        } catch (error) {
          // Se c'è un errore specifico sullo scope, suggerisci di pulire localStorage
          if (error.message && error.message.includes("decrypt")) {
            const enhancedError = new Error(
              `${error.message}\n\nConsiglio: Prova a pulire localStorage con 'localStorage.clear()' e riavvia l'applicazione.`
            );
            showError("Login Bitcoin", enhancedError);
          } else {
            showError("Login Bitcoin", error);
          }
        }
      });

      // Registrazione con Bitcoin
      bitcoinSignupBtn.addEventListener("click", async function (e) {
        e.preventDefault();

        if (!shogun) {
          showError(
            "Registrazione Bitcoin",
            new Error("Shogun non è stato inizializzato!")
          );
          return;
        }

        if (!bitcoinPlugin) {
          showError(
            "Registrazione Bitcoin",
            new Error("Plugin Bitcoin non disponibile")
          );
          return;
        }

        if (!bitcoinAddress) {
          showError(
            "Registrazione Bitcoin",
            new Error("Nessun indirizzo Bitcoin configurato")
          );
          return;
        }

        try {
          showResult("Bitcoin Wallet", {
            message: "Registrazione in corso...",
            address: bitcoinAddress,
          });

          // Ottieni l'opzione del wallet type
          const walletType = bitcoinWalletTypeSelect.value;

          // Genera un alias dal timestamp e indirizzo per assicurarsi che sia univoco
          const alias = `btc_user_${Date.now().toString(36)}_${bitcoinAddress.substring(0, 6)}`;

          // Prepara opzioni aggiuntive
          const options = {
            walletType,
            alias,
            forceCreate: true, // Forza la creazione anche se l'utente potrebbe esistere
          };

          console.log("Registrazione Bitcoin con opzioni:", options);

          // Usa il metodo appropriato per la registrazione
          let result;
          if (typeof bitcoinPlugin.signUp === "function") {
            result = await bitcoinPlugin.signUp(bitcoinAddress, options);
          } else {
            throw new Error("Metodo di registrazione non disponibile");
          }

          if (result.success) {
            // Salva l'alias generato in localStorage per il login successivo
            localStorage.setItem("bitcoin_user_alias", alias);
            showResult("Registrazione con Bitcoin completata", result);
          } else {
            // Se l'errore è "User already created" (utente già creato), salviamo comunque l'alias e suggeriamo di provare il login
            if (
              result.error &&
              (result.error.includes("already created") ||
                result.error.includes("già creato") ||
                result.error.includes("already exists") ||
                result.error.includes("[object Object]"))
            ) {
              // Salva comunque l'alias, potrebbe essere utile per il login
              localStorage.setItem("bitcoin_user_alias", alias);
              showResult("Account già esistente", {
                success: true,
                message: "L'utente esiste già. Prova a effettuare il login.",
                alias: alias,
                suggestion: "Clicca sul pulsante 'Login con Bitcoin' per accedere."
              });
            } else {
              showError(
                "Registrazione Bitcoin",
                new Error(result.error || "Registrazione fallita")
              );
            }
          }
        } catch (error) {
          showError("Registrazione Bitcoin", error);
        }
      });

      // Creazione di un nuovo wallet
      createWalletBtn.addEventListener("click", async function (e) {
        e.preventDefault();

        if (!shogun) {
          showError(
            "Creazione Wallet",
            new Error("Shogun non è stato inizializzato!")
          );
          return;
        }

        if (!shogun.isLoggedIn()) {
          showError(
            "Creazione Wallet",
            new Error("Devi effettuare il login prima!")
          );
          return;
        }

        try {
          if (!bip32Plugin) {
            showError(
              "Creazione Wallet",
              new Error("Plugin BIP32 non disponibile")
            );
            return;
          }

          const wallet = await bip32Plugin.createWallet();
          showResult("Wallet Creato", wallet);
        } catch (error) {
          showError("Creazione Wallet", error);
        }
      });

      // Ottenimento dei wallet esistenti
      getWalletsBtn.addEventListener("click", async function (e) {
        e.preventDefault();

        if (!shogun) {
          showError(
            "Ottenimento Wallets",
            new Error("Shogun non è stato inizializzato!")
          );
          return;
        }

        if (!shogun.isLoggedIn()) {
          showError(
            "Ottenimento Wallets",
            new Error("Devi effettuare il login prima!")
          );
          return;
        }

        try {
          if (!bip32Plugin) {
            showError(
              "Ottenimento Wallets",
              new Error("Plugin BIP32 non disponibile")
            );
            return;
          }

          const wallets = await bip32Plugin.loadWallets();
          showResult("Wallets Disponibili", wallets);
        } catch (error) {
          showError("Ottenimento Wallets", error);
        }
      });

      // Gestione dell'inserimento dell'indirizzo Bitcoin manuale
      bitcoinManualAddress.addEventListener("input", function () {
        if (this.value) {
          bitcoinAddress = this.value;
          bitcoinAddressDiv.textContent = `Indirizzo: ${bitcoinAddress}`;
          bitcoinLoginBtn.disabled = false;
          bitcoinSignupBtn.disabled = false;
        } else {
          bitcoinAddress = "";
          bitcoinAddressDiv.textContent = "Indirizzo non rilevato";
          bitcoinLoginBtn.disabled = true;
          bitcoinSignupBtn.disabled = true;
        }
      });

      // Collegamento al tipo di wallet Bitcoin
      bitcoinWalletTypeSelect.addEventListener("change", function (e) {
        if (e.target.value === "manual") {
          bitcoinManualSection.style.display = "block";
        } else {
          bitcoinManualSection.style.display = "none";
        }
      });

      // Test Gun Connection
      document
        .getElementById("testGunBtn")
        .addEventListener("click", function (e) {
          e.preventDefault();

          if (!shogun || !shogun.gun) {
            showError("Test Gun", "Shogun o Gun non inizializzato");
            return;
          }

          const testKey = `test_key_${Date.now()}`;
          const testData = { message: "Test data", timestamp: Date.now() };

          console.log(`Testing Gun connection with key: ${testKey}`);
          showResult("Gun Test", { status: "Testing...", key: testKey });

          // Put some test data
          shogun.gun.get(testKey).put(testData, (ack) => {
            if (ack.err) {
              showError("Gun Test", `Put failed: ${ack.err}`);
              console.error("Gun put error:", ack.err);
            } else {
              console.log("Gun put successful:", ack);

              // Try to read back the data
              shogun.gun.get(testKey).once((data) => {
                if (data) {
                  showResult("Gun Test", {
                    status: "Success",
                    sentData: testData,
                    receivedData: data,
                    match: data.message === testData.message,
                  });
                  console.log("Gun read successful:", data);
                } else {
                  showError("Gun Test", "Read failed: No data received");
                  console.error("Gun read error: No data");
                }
              });
            }
          });
        });

      // Controlla il supporto delle tecnologie all'avvio della pagina
      document.addEventListener("DOMContentLoaded", () => {
        checkWebAuthnSupport();
        checkEthereumSupport();
        checkBitcoinSupport();
      });

      // Previeni il submit del form su tutti gli input
      document.addEventListener("keypress", function (e) {
        if (
          e.key === "Enter" &&
          (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA")
        ) {
          e.preventDefault(); // Previene il refresh della pagina
        }
      });

      // Previeni il comportamento predefinito per tutti i pulsanti nei form
      document.addEventListener("click", function (e) {
        if (e.target.tagName === "BUTTON" && e.target.type !== "button") {
          e.preventDefault(); // Previene il refresh della pagina per i pulsanti senza type="button"
        }
      });
    </script>
  </body>
</html>
